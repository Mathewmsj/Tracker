<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æµé‡åˆ†æ Â· Analytics</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <style>
    :root {
      --bg-dark: #0a0a0f;
      --bg-card: rgba(20, 20, 30, 0.6);
      --border: rgba(255, 255, 255, 0.06);
      --accent-1: #ff6b6b;
      --accent-2: #4ecdc4;
      --accent-3: #ffe66d;
      --accent-4: #95e1d3;
      --text-1: #ffffff;
      --text-2: rgba(255, 255, 255, 0.6);
      --text-3: rgba(255, 255, 255, 0.3);
      --glow-1: rgba(255, 107, 107, 0.4);
      --glow-2: rgba(78, 205, 196, 0.4);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Space Grotesk', -apple-system, sans-serif;
      background: var(--bg-dark);
      color: var(--text-1);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Animated gradient mesh background */
    .bg-mesh {
      position: fixed;
      inset: 0;
      z-index: 0;
      background:
        radial-gradient(ellipse 80% 50% at 20% 40%, rgba(255, 107, 107, 0.15) 0%, transparent 50%),
        radial-gradient(ellipse 60% 40% at 80% 20%, rgba(78, 205, 196, 0.12) 0%, transparent 50%),
        radial-gradient(ellipse 50% 60% at 60% 80%, rgba(255, 230, 109, 0.08) 0%, transparent 50%);
      animation: meshFloat 30s ease-in-out infinite;
    }

    @keyframes meshFloat {

      0%,
      100% {
        filter: blur(60px) brightness(1);
      }

      50% {
        filter: blur(80px) brightness(1.2);
      }
    }

    .noise {
      position: fixed;
      inset: 0;
      z-index: 1;
      opacity: 0.03;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
      pointer-events: none;
    }

    .container {
      position: relative;
      z-index: 2;
      max-width: 1400px;
      margin: 0 auto;
      padding: 3rem 2rem;
    }

    /* Header */
    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-bottom: 4rem;
      padding-bottom: 2rem;
      border-bottom: 1px solid var(--border);
    }

    .brand {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .brand h1 {
      font-size: 2.5rem;
      font-weight: 700;
      letter-spacing: -0.03em;
      background: linear-gradient(135deg, var(--text-1) 0%, var(--text-2) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .brand p {
      font-size: 0.875rem;
      color: var(--text-3);
      letter-spacing: 0.2em;
      text-transform: uppercase;
    }

    .live-indicator {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1.5rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 100px;
      backdrop-filter: blur(20px);
    }

    .pulse {
      width: 8px;
      height: 8px;
      background: var(--accent-2);
      border-radius: 50%;
      animation: pulse 2s ease infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        box-shadow: 0 0 0 0 var(--glow-2);
      }

      50% {
        box-shadow: 0 0 0 12px transparent;
      }
    }

    /* Stats Grid - Bento Style */
    .bento {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: auto auto;
      gap: 1.5rem;
      margin-bottom: 3rem;
    }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 2rem;
      backdrop-filter: blur(40px);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.03) 0%, transparent 50%);
      pointer-events: none;
    }

    .card:hover {
      transform: translateY(-4px);
      border-color: rgba(255, 255, 255, 0.12);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
    }

    .stat-card {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 160px;
    }

    .stat-card .label {
      font-size: 0.75rem;
      color: var(--text-3);
      text-transform: uppercase;
      letter-spacing: 0.15em;
      margin-bottom: 0.5rem;
    }

    .stat-card .value {
      font-size: 3.5rem;
      font-weight: 700;
      line-height: 1;
      letter-spacing: -0.03em;
    }

    .stat-card:nth-child(1) .value {
      color: var(--accent-1);
      text-shadow: 0 0 40px var(--glow-1);
    }

    .stat-card:nth-child(2) .value {
      color: var(--accent-2);
      text-shadow: 0 0 40px var(--glow-2);
    }

    .stat-card:nth-child(3) .value {
      color: var(--accent-3);
    }

    .stat-card:nth-child(4) .value {
      color: var(--accent-4);
    }

    .stat-card .trend {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
      width: fit-content;
    }

    .trend.up {
      background: rgba(78, 205, 196, 0.15);
      color: var(--accent-2);
    }

    .trend.down {
      background: rgba(255, 107, 107, 0.15);
      color: var(--accent-1);
    }

    /* Chart Cards */
    .chart-area {
      grid-column: span 2;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .chart-header h3 {
      font-size: 1rem;
      font-weight: 500;
      color: var(--text-2);
    }

    .chart-header .badge {
      font-size: 0.7rem;
      padding: 0.25rem 0.75rem;
      background: rgba(255, 107, 107, 0.15);
      color: var(--accent-1);
      border-radius: 100px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .chart-container {
      height: 250px;
    }

    /* Sankey Section */
    .sankey-section {
      margin-bottom: 3rem;
    }

    .sankey-section .card {
      padding: 2.5rem;
    }

    .sankey-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .sankey-header h2 {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .sankey-header .subtitle {
      color: var(--text-3);
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }

    #sankeyChart {
      height: 450px;
    }

    /* Tables Grid */
    .tables-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1.5rem;
    }

    .table-card h3 {
      font-size: 1rem;
      font-weight: 500;
      color: var(--text-2);
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    tr {
      transition: background 0.2s;
    }

    tbody tr:hover {
      background: rgba(255, 255, 255, 0.02);
    }

    th,
    td {
      padding: 1rem 0;
      text-align: left;
    }

    th {
      font-size: 0.65rem;
      color: var(--text-3);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-weight: 500;
    }

    td {
      font-size: 0.9rem;
      border-bottom: 1px solid var(--border);
    }

    tr:last-child td {
      border-bottom: none;
    }

    .page-cell {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .page-icon {
      width: 36px;
      height: 36px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }

    .page-url {
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .count-pill {
      display: inline-flex;
      padding: 0.4rem 0.8rem;
      background: linear-gradient(135deg, rgba(255, 107, 107, 0.1), rgba(78, 205, 196, 0.1));
      border: 1px solid var(--border);
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.85rem;
    }

    .rank {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
    }

    .rank-1 {
      background: linear-gradient(135deg, #ffd700, #ffb347);
      color: #000;
    }

    .rank-2 {
      background: linear-gradient(135deg, #c0c0c0, #a8a8a8);
      color: #000;
    }

    .rank-3 {
      background: linear-gradient(135deg, #cd7f32, #b8860b);
      color: #000;
    }

    .rank-n {
      background: var(--bg-card);
      color: var(--text-3);
      border: 1px solid var(--border);
    }

    /* Loading */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 60vh;
      gap: 2rem;
    }

    .loader {
      width: 48px;
      height: 48px;
      border: 2px solid var(--border);
      border-top-color: var(--accent-1);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--text-3);
    }

    .empty-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .bento {
        grid-template-columns: repeat(2, 1fr);
      }

      .chart-area {
        grid-column: span 2;
      }
    }

    @media (max-width: 768px) {
      .bento {
        grid-template-columns: 1fr;
      }

      .chart-area {
        grid-column: span 1;
      }

      .tables-grid {
        grid-template-columns: 1fr;
      }

      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1.5rem;
      }
    }
  </style>
</head>

<body>
  <div class="bg-mesh"></div>
  <div class="noise"></div>

  <div class="container">
    <header>
      <div class="brand">
        <h1>Analytics</h1>
        <p>Real-time Traffic Insights</p>
      </div>
      <div class="live-indicator">
        <span class="pulse"></span>
        <span id="lastUpdated">è¿æ¥ä¸­...</span>
      </div>
    </header>

    <div id="content">
      <div class="loading">
        <div class="loader"></div>
        <p style="color: var(--text-3)">åŠ è½½æ•°æ®ä¸­...</p>
      </div>
    </div>
  </div>

  <script>
    let trendChart = null, hourlyChart = null, sankeyChart = null;

    async function loadStats() {
      try {
        const [statsRes, flowRes] = await Promise.all([
          fetch('/api/stats'),
          fetch('/api/flow')
        ]);

        if (!statsRes.ok) throw new Error('åŠ è½½å¤±è´¥');

        const stats = await statsRes.json();
        const flow = flowRes.ok ? await flowRes.json() : { nodes: [], links: [] };

        renderDashboard(stats, flow);
        document.getElementById('lastUpdated').textContent =
          `æ›´æ–°äº ${new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}`;
      } catch (error) {
        document.getElementById('content').innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">âš ï¸</div>
            <p>${error.message}</p>
          </div>
        `;
      }
    }

    function renderDashboard(data, flow) {
      const avgDepth = data.uv > 0 ? (data.pv / data.uv).toFixed(1) : '0';
      const bounceRate = data.uv > 0 ? Math.max(15, 100 - (data.pv / data.uv * 12)).toFixed(1) : '0';

      document.getElementById('content').innerHTML = `
        <div class="bento">
          <div class="card stat-card">
            <div>
              <div class="label">é¡µé¢æµè§ˆé‡</div>
              <div class="value">${formatNum(data.pv)}</div>
            </div>
            <div class="trend up">â†‘ 12.5%</div>
          </div>
          <div class="card stat-card">
            <div>
              <div class="label">ç‹¬ç«‹è®¿å®¢</div>
              <div class="value">${formatNum(data.uv)}</div>
            </div>
            <div class="trend up">â†‘ 8.2%</div>
          </div>
          <div class="card stat-card">
            <div>
              <div class="label">è®¿é—®æ·±åº¦</div>
              <div class="value">${avgDepth}</div>
            </div>
            <div class="trend up">â†‘ 3.1%</div>
          </div>
          <div class="card stat-card">
            <div>
              <div class="label">è·³å‡ºç‡</div>
              <div class="value">${bounceRate}%</div>
            </div>
            <div class="trend down">â†“ 2.4%</div>
          </div>
          
          <div class="card chart-area">
            <div class="chart-header">
              <h3>å®æ—¶æµé‡è¶‹åŠ¿</h3>
              <span class="badge">æœ€è¿‘1å°æ—¶</span>
            </div>
            <div class="chart-container"><canvas id="trendChart"></canvas></div>
          </div>
          <div class="card chart-area">
            <div class="chart-header">
              <h3>ä»Šæ—¥åˆ†æ—¶ç»Ÿè®¡</h3>
            </div>
            <div class="chart-container"><canvas id="hourlyChart"></canvas></div>
          </div>
        </div>

        <div class="sankey-section">
          <div class="card">
            <div class="sankey-header">
              <div>
                <h2>ç”¨æˆ·è¡Œä¸ºæµå‘</h2>
                <p class="subtitle">å¯è§†åŒ–ç”¨æˆ·åœ¨ç«™ç‚¹å†…çš„å¯¼èˆªè·¯å¾„</p>
              </div>
            </div>
            <div id="sankeyChart"></div>
          </div>
        </div>

        <div class="tables-grid">
          <div class="card table-card">
            <h3>ğŸ”¥ çƒ­é—¨é¡µé¢</h3>
            <table>
              <thead><tr><th>æ’å</th><th>é¡µé¢</th><th style="text-align:right">æµè§ˆé‡</th></tr></thead>
              <tbody>
                ${data.topPages.length ? data.topPages.slice(0, 6).map((p, i) => `
                  <tr>
                    <td><span class="rank ${i < 3 ? 'rank-' + (i + 1) : 'rank-n'}">${i + 1}</span></td>
                    <td><div class="page-cell"><span class="page-icon">${getIcon(p.url)}</span><span class="page-url" title="${p.url}">${p.url}</span></div></td>
                    <td style="text-align:right"><span class="count-pill">${p.count}</span></td>
                  </tr>
                `).join('') : '<tr><td colspan="3"><div class="empty-state"><div class="empty-icon">ğŸ“­</div><p>æš‚æ— æ•°æ®</p></div></td></tr>'}
              </tbody>
            </table>
          </div>
          <div class="card table-card">
            <h3>ğŸ”— æµé‡æ¥æº</h3>
            <table>
              <thead><tr><th>æ’å</th><th>æ¥æº</th><th style="text-align:right">è®¿é—®é‡</th></tr></thead>
              <tbody>
                ${data.topReferrers.length ? data.topReferrers.slice(0, 6).map((r, i) => `
                  <tr>
                    <td><span class="rank ${i < 3 ? 'rank-' + (i + 1) : 'rank-n'}">${i + 1}</span></td>
                    <td><div class="page-cell"><span class="page-icon">${getRefIcon(r.referrer)}</span><span class="page-url">${formatRef(r.referrer)}</span></div></td>
                    <td style="text-align:right"><span class="count-pill">${r.count}</span></td>
                  </tr>
                `).join('') : '<tr><td colspan="3"><div class="empty-state"><div class="empty-icon">ğŸ“­</div><p>æš‚æ— æ•°æ®</p></div></td></tr>'}
              </tbody>
            </table>
          </div>
        </div>
      `;

      renderTrendChart(data.minuteTrend);
      renderHourlyChart(data.hourlyTrend);
      renderSankey(flow);
    }

    function renderTrendChart(trend) {
      const ctx = document.getElementById('trendChart')?.getContext('2d');
      if (!ctx) return;
      if (trendChart) trendChart.destroy();

      const gradient = ctx.createLinearGradient(0, 0, 0, 250);
      gradient.addColorStop(0, 'rgba(255, 107, 107, 0.3)');
      gradient.addColorStop(1, 'rgba(255, 107, 107, 0)');

      trendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: trend.map(d => d.minute?.split(' ')[1] || d.minute),
          datasets: [{
            data: trend.map(d => d.count),
            borderColor: '#ff6b6b',
            backgroundColor: gradient,
            fill: true,
            tension: 0.4,
            pointRadius: 0,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { color: 'rgba(255,255,255,0.3)', maxTicksLimit: 6 } },
            y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { color: 'rgba(255,255,255,0.3)' } }
          }
        }
      });
    }

    function renderHourlyChart(hourly) {
      const ctx = document.getElementById('hourlyChart')?.getContext('2d');
      if (!ctx) return;
      if (hourlyChart) hourlyChart.destroy();

      hourlyChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: hourly.map(d => `${d.hour}:00`),
          datasets: [{
            data: hourly.map(d => d.count),
            backgroundColor: (context) => {
              const chart = context.chart;
              const { ctx, chartArea } = chart;
              if (!chartArea) return '#4ecdc4';
              const grad = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
              grad.addColorStop(0, '#4ecdc4');
              grad.addColorStop(1, '#ff6b6b');
              return grad;
            },
            borderRadius: 8,
            borderSkipped: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { display: false }, ticks: { color: 'rgba(255,255,255,0.3)' } },
            y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { color: 'rgba(255,255,255,0.3)' } }
          }
        }
      });
    }

    function renderSankey(flow) {
      const container = document.getElementById('sankeyChart');
      if (!container || !flow.nodes.length) {
        if (container) container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸŒŠ</div><p>æš‚æ— æµå‘æ•°æ®</p></div>';
        return;
      }

      if (sankeyChart) sankeyChart.dispose();
      sankeyChart = echarts.init(container);

      const colors = ['#ff6b6b', '#4ecdc4', '#ffe66d', '#95e1d3', '#dfe6e9', '#a29bfe', '#fd79a8', '#00b894'];

      sankeyChart.setOption({
        tooltip: {
          trigger: 'item',
          backgroundColor: 'rgba(10, 10, 15, 0.95)',
          borderColor: 'rgba(255,255,255,0.1)',
          textStyle: { color: '#fff' },
          formatter: p => p.dataType === 'edge'
            ? `<b>${p.data.source}</b> â†’ <b>${p.data.target}</b><br/>è®¿é—®: ${p.data.value}`
            : `<b>${p.name}</b>`
        },
        series: [{
          type: 'sankey',
          layout: 'none',
          emphasis: { focus: 'adjacency' },
          nodeAlign: 'left',
          lineStyle: { color: 'gradient', curveness: 0.5, opacity: 0.35 },
          itemStyle: { borderWidth: 0 },
          label: { color: '#fff', fontSize: 11 },
          data: flow.nodes.map((n, i) => ({ ...n, itemStyle: { color: colors[i % colors.length] } })),
          links: flow.links
        }]
      });

      window.addEventListener('resize', () => sankeyChart?.resize());
    }

    function formatNum(n) {
      if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
      if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
      return n.toLocaleString();
    }

    function getIcon(url) {
      if (url === '/') return 'ğŸ ';
      if (url.includes('product')) return 'ğŸ›’';
      if (url.includes('blog')) return 'ğŸ“';
      if (url.includes('doc')) return 'ğŸ“š';
      if (url.includes('about')) return 'â„¹ï¸';
      if (url.includes('pricing')) return 'ğŸ’°';
      return 'ğŸ“„';
    }

    function getRefIcon(ref) {
      if (!ref) return 'ğŸ¯';
      if (ref.includes('google')) return 'ğŸ”';
      if (ref.includes('twitter')) return 'ğŸ¦';
      if (ref.includes('github')) return 'ğŸ™';
      return 'ğŸŒ';
    }

    function formatRef(ref) {
      if (!ref || ref === 'direct') return 'ç›´æ¥è®¿é—®';
      if (ref.includes('google')) return 'Google';
      if (ref.includes('github')) return 'GitHub';
      return ref.replace(/https?:\/\//, '').split('/')[0];
    }

    loadStats();
    setInterval(loadStats, 30000);
  </script>
</body>

</html>