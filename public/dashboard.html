<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æµé‡åˆ†æ Â· Analytics</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <style>
    :root {
      --bg-dark: #0a0a0f;
      --bg-card: rgba(20, 20, 30, 0.6);
      --border: rgba(255, 255, 255, 0.06);
      --accent-1: #ff6b6b;
      --accent-2: #4ecdc4;
      --accent-3: #ffe66d;
      --accent-4: #95e1d3;
      --accent-5: #a29bfe;
      --text-1: #ffffff;
      --text-2: rgba(255, 255, 255, 0.6);
      --text-3: rgba(255, 255, 255, 0.3);
      --danger: #e74c3c;
      --success: #2ecc71;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Space Grotesk', sans-serif;
      background: var(--bg-dark);
      color: var(--text-1);
      min-height: 100vh;
    }

    .bg-mesh {
      position: fixed;
      inset: 0;
      z-index: 0;
      background: radial-gradient(ellipse 80% 50% at 20% 40%, rgba(255, 107, 107, 0.12) 0%, transparent 50%), radial-gradient(ellipse 60% 40% at 80% 20%, rgba(78, 205, 196, 0.1) 0%, transparent 50%);
    }

    .container {
      position: relative;
      z-index: 2;
      max-width: 1600px;
      margin: 0 auto;
      padding: 1.5rem;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
      gap: 1rem;
    }

    .brand h1 {
      font-size: 1.8rem;
      background: linear-gradient(135deg, var(--text-1), var(--text-2));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .brand p {
      font-size: 0.7rem;
      color: var(--text-3);
      text-transform: uppercase;
      letter-spacing: 0.15em;
    }

    .header-actions {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .date-selector {
      display: flex;
      gap: 0.25rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 0.25rem;
    }

    .date-btn {
      padding: 0.4rem 0.8rem;
      border: none;
      background: transparent;
      color: var(--text-2);
      cursor: pointer;
      border-radius: 8px;
      font-size: 0.75rem;
      transition: all 0.2s;
    }

    .date-btn.active {
      background: var(--accent-2);
      color: #000;
      font-weight: 600;
    }

    .date-btn:hover:not(.active) {
      background: rgba(255, 255, 255, 0.05);
    }

    .toggle-group {
      display: inline-flex;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 6px;
      padding: 2px;
    }

    .toggle-btn {
      padding: 0.25rem 0.5rem;
      border: none;
      background: transparent;
      color: var(--text-3);
      cursor: pointer;
      border-radius: 4px;
      font-size: 0.6rem;
      font-weight: 600;
      transition: all 0.2s;
    }

    .toggle-btn.active {
      background: var(--accent-1);
      color: #000;
    }

    .toggle-btn:hover:not(.active) {
      color: var(--text-1);
    }

    .realtime-badge {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: linear-gradient(135deg, rgba(46, 204, 113, 0.15), rgba(39, 174, 96, 0.1));
      border: 1px solid rgba(46, 204, 113, 0.3);
      border-radius: 10px;
    }

    .realtime-dot {
      width: 8px;
      height: 8px;
      background: var(--success);
      border-radius: 50%;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.5);
      }

      50% {
        box-shadow: 0 0 0 8px transparent;
      }
    }

    .realtime-count {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--success);
    }

    .realtime-label {
      font-size: 0.65rem;
      color: var(--text-3);
    }

    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.75rem;
      font-weight: 600;
      transition: all 0.2s;
    }

    .btn-danger {
      background: rgba(231, 76, 60, 0.15);
      color: var(--danger);
      border: 1px solid rgba(231, 76, 60, 0.3);
    }

    .btn-danger:hover {
      background: var(--danger);
      color: white;
    }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1.25rem;
      backdrop-filter: blur(20px);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .stat-card {
      text-align: center;
    }

    .stat-card .value {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }

    .stat-card .label {
      font-size: 0.65rem;
      color: var(--text-3);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .stat-card:nth-child(1) .value {
      color: var(--accent-1);
    }

    .stat-card:nth-child(2) .value {
      color: var(--accent-2);
    }

    .stat-card:nth-child(3) .value {
      color: var(--accent-3);
    }

    .stat-card:nth-child(4) .value {
      color: var(--accent-4);
    }

    .stat-card:nth-child(5) .value {
      color: var(--accent-5);
    }

    .stat-card:nth-child(6) .value {
      color: var(--accent-1);
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .grid-4 {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .chart-container {
      height: 200px;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      gap: 0.5rem;
    }

    .chart-header h3 {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-2);
    }

    .badge {
      font-size: 0.6rem;
      padding: 0.2rem 0.5rem;
      background: rgba(255, 107, 107, 0.15);
      color: var(--accent-1);
      border-radius: 100px;
    }

    #sankeyChart {
      height: 300px;
    }

    .pie-container {
      height: 180px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    th {
      text-align: left;
      padding: 0.6rem 0;
      font-size: 0.6rem;
      color: var(--text-3);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid var(--border);
    }

    td {
      padding: 0.6rem 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.02);
    }

    tr:hover {
      background: rgba(255, 255, 255, 0.02);
    }

    .visitors-table {
      max-height: 280px;
      overflow-y: auto;
    }

    .ip-badge {
      display: inline-block;
      padding: 0.15rem 0.4rem;
      background: rgba(78, 205, 196, 0.15);
      color: var(--accent-2);
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.7rem;
    }

    .device-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.2rem;
      padding: 0.15rem 0.4rem;
      background: rgba(255, 230, 109, 0.15);
      color: var(--accent-3);
      border-radius: 4px;
      font-size: 0.65rem;
    }

    .url-badge {
      display: inline-block;
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      padding: 0.15rem 0.4rem;
      background: rgba(255, 107, 107, 0.1);
      border-radius: 4px;
      font-size: 0.7rem;
    }

    .time-badge {
      font-size: 0.65rem;
      color: var(--text-3);
    }

    .channel-bar {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 0.6rem;
    }

    .channel-label {
      width: 55px;
      font-size: 0.65rem;
      color: var(--text-2);
    }

    .channel-track {
      flex: 1;
      height: 22px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 6px;
      overflow: hidden;
    }

    .channel-fill {
      height: 100%;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 0.5rem;
      font-size: 0.6rem;
      font-weight: 600;
      transition: width 0.5s;
      min-width: 28px;
    }

    .channel-fill.direct {
      background: linear-gradient(90deg, var(--accent-1), #ff8787);
    }

    .channel-fill.search {
      background: linear-gradient(90deg, var(--accent-2), #7ee8db);
    }

    .channel-fill.social {
      background: linear-gradient(90deg, var(--accent-5), #c4b5fd);
    }

    .channel-fill.referral {
      background: linear-gradient(90deg, var(--accent-3), #fff59d);
      color: #333;
    }

    .rank {
      width: 20px;
      height: 20px;
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.65rem;
      font-weight: 700;
    }

    .rank-1 {
      background: linear-gradient(135deg, #ffd700, #ffb347);
      color: #000;
    }

    .rank-2 {
      background: linear-gradient(135deg, #c0c0c0, #a8a8a8);
      color: #000;
    }

    .rank-3 {
      background: linear-gradient(135deg, #cd7f32, #b8860b);
      color: #000;
    }

    .rank-n {
      background: var(--bg-card);
      color: var(--text-3);
      border: 1px solid var(--border);
    }

    .count-pill {
      padding: 0.2rem 0.5rem;
      background: linear-gradient(135deg, rgba(255, 107, 107, 0.1), rgba(78, 205, 196, 0.1));
      border: 1px solid var(--border);
      border-radius: 5px;
      font-weight: 600;
      font-size: 0.75rem;
    }

    .layer-controls {
      display: flex;
      gap: 0.3rem;
    }

    .layer-btn {
      padding: 0.25rem 0.5rem;
      font-size: 0.65rem;
      min-width: 24px;
      background: var(--bg-card);
      color: var(--text-2);
      border: 1px solid var(--border);
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .layer-btn.active {
      background: var(--accent-2);
      color: #000;
      border-color: var(--accent-2);
    }

    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 40vh;
      gap: 1rem;
    }

    .loader {
      width: 36px;
      height: 36px;
      border: 2px solid var(--border);
      border-top-color: var(--accent-1);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .empty-state {
      text-align: center;
      padding: 1.5rem;
      color: var(--text-3);
      font-size: 0.85rem;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal {
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1.5rem;
      max-width: 360px;
      text-align: center;
    }

    .modal h3 {
      margin-bottom: 0.75rem;
      color: var(--danger);
      font-size: 1rem;
    }

    .modal p {
      color: var(--text-2);
      margin-bottom: 1.25rem;
      font-size: 0.85rem;
    }

    .modal-buttons {
      display: flex;
      gap: 0.75rem;
      justify-content: center;
    }

    .btn-cancel {
      background: var(--bg-card);
      color: var(--text-2);
      border: 1px solid var(--border);
    }

    .btn-confirm-delete {
      background: var(--danger);
      color: white;
      border: none;
    }

    @media (max-width: 1200px) {
      .stats-grid {
        grid-template-columns: repeat(3, 1fr);
      }

      .grid-3,
      .grid-4 {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 768px) {

      .stats-grid,
      .grid-2,
      .grid-3,
      .grid-4 {
        grid-template-columns: 1fr;
      }

      header {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>

<body>
  <div class="bg-mesh"></div>
  <div class="container">
    <header>
      <div class="brand">
        <h1>Analytics</h1>
        <p>Real-time Insights</p>
      </div>
      <div class="header-actions">
        <div class="date-selector">
          <button class="date-btn active" data-range="today" onclick="setDateRange('today',this)">ä»Šæ—¥</button>
          <button class="date-btn" data-range="week" onclick="setDateRange('week',this)">æœ¬å‘¨</button>
          <button class="date-btn" data-range="month" onclick="setDateRange('month',this)">æœ¬æœˆ</button>
          <button class="date-btn" data-range="all" onclick="setDateRange('all',this)">å…¨éƒ¨</button>
        </div>
        <div class="realtime-badge">
          <span class="realtime-dot"></span>
          <div><span class="realtime-count" id="realtimeCount">0</span>
            <div class="realtime-label">å®æ—¶åœ¨çº¿</div>
          </div>
        </div>
        <button class="btn btn-danger" onclick="showClearModal()">ğŸ—‘ï¸ æ¸…ç©º</button>
      </div>
    </header>
    <div id="content">
      <div class="loading">
        <div class="loader"></div>
        <p style="color:var(--text-3)">åŠ è½½ä¸­...</p>
      </div>
    </div>
    <div id="modal-container"></div>
  </div>

  <script>
    let trendChart = null, hourlyChart = null, sankeyChart = null, deviceChart = null, browserChart = null;
    let currentRange = 'today';
    let currentLayers = 5;
    let cachedData = null;

    // Toggle states: 'pv' or 'uv'
    let toggleState = { device: 'pv', browser: 'pv', channel: 'pv', pages: 'pv' };

    async function loadStats() {
      try {
        const [statsRes, flowRes, visitorsRes] = await Promise.all([
          fetch(`/api/stats?range=${currentRange}`),
          fetch(`/api/flow?maxLayers=${currentLayers}`),
          fetch('/api/visitors?limit=15')
        ]);
        if (!statsRes.ok) throw new Error('åŠ è½½å¤±è´¥');
        cachedData = {
          stats: await statsRes.json(),
          flow: flowRes.ok ? await flowRes.json() : { nodes: [], links: [] },
          visitors: visitorsRes.ok ? await visitorsRes.json() : { visitors: [] }
        };
        document.getElementById('realtimeCount').textContent = cachedData.stats.realtimeUsers || 0;
        renderDashboard();
      } catch (error) {
        document.getElementById('content').innerHTML = `<div class="empty-state">âš ï¸ ${error.message}</div>`;
      }
    }

    function setDateRange(range, btn) {
      currentRange = range;
      document.querySelectorAll('.date-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      loadStats();
    }

    function setToggle(key, value, btn) {
      toggleState[key] = value;
      btn.parentElement.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      renderDashboard();
    }

    async function reloadSankey(layers) {
      currentLayers = layers;
      const flowRes = await fetch(`/api/flow?maxLayers=${layers}`);
      cachedData.flow = flowRes.ok ? await flowRes.json() : { nodes: [], links: [] };
      renderSankey(cachedData.flow);
      document.querySelectorAll('.layer-btn').forEach(btn => btn.classList.toggle('active', parseInt(btn.dataset.layers) === layers));
    }

    function renderDashboard() {
      const data = cachedData.stats;
      const flow = cachedData.flow;
      const visitorsData = cachedData.visitors;

      const avgDepth = data.uv > 0 ? (data.pv / data.uv).toFixed(1) : '0';
      const bounceRate = data.uv > 0 ? Math.max(15, 100 - (data.pv / data.uv * 10)).toFixed(0) : '0';

      const channels = data.channels?.[toggleState.channel] || {};
      const totalChannels = Object.values(channels).reduce((a, b) => a + b, 0) || 1;
      const topPages = data.topPages?.[toggleState.pages] || [];

      document.getElementById('content').innerHTML = `
        <div class="stats-grid">
          <div class="card stat-card"><div class="value">${formatNum(data.pv)}</div><div class="label">æµè§ˆé‡ PV</div></div>
          <div class="card stat-card"><div class="value">${formatNum(data.uv)}</div><div class="label">è®¿å®¢æ•° UV</div></div>
          <div class="card stat-card"><div class="value">${data.newVisitors || 0}</div><div class="label">æ–°è®¿å®¢</div></div>
          <div class="card stat-card"><div class="value">${data.returningVisitors || 0}</div><div class="label">å›è®¿ç”¨æˆ·</div></div>
          <div class="card stat-card"><div class="value">${avgDepth}</div><div class="label">è®¿é—®æ·±åº¦</div></div>
          <div class="card stat-card"><div class="value">${bounceRate}%</div><div class="label">è·³å‡ºç‡</div></div>
        </div>

        <div class="grid-4">
          <div class="card">
            <div class="chart-header"><h3>ğŸ“ˆ ${currentRange === 'today' ? 'ä»Šæ—¥åˆ†æ—¶' : 'æ¯æ—¥è¶‹åŠ¿'}</h3><span class="badge">${data.dateRange?.range || 'today'}</span></div>
            <div class="chart-container"><canvas id="hourlyChart"></canvas></div>
          </div>
          <div class="card">
            <div class="chart-header">
              <h3>ğŸ“± è®¾å¤‡</h3>
              <div class="toggle-group">
                <button class="toggle-btn ${toggleState.device === 'pv' ? 'active' : ''}" onclick="setToggle('device','pv',this)">PV</button>
                <button class="toggle-btn ${toggleState.device === 'uv' ? 'active' : ''}" onclick="setToggle('device','uv',this)">UV</button>
              </div>
            </div>
            <div class="pie-container"><canvas id="deviceChart"></canvas></div>
          </div>
          <div class="card">
            <div class="chart-header">
              <h3>ğŸŒ æµè§ˆå™¨</h3>
              <div class="toggle-group">
                <button class="toggle-btn ${toggleState.browser === 'pv' ? 'active' : ''}" onclick="setToggle('browser','pv',this)">PV</button>
                <button class="toggle-btn ${toggleState.browser === 'uv' ? 'active' : ''}" onclick="setToggle('browser','uv',this)">UV</button>
              </div>
            </div>
            <div class="pie-container"><canvas id="browserChart"></canvas></div>
          </div>
        </div>

        <div class="grid-2">
          <div class="card">
            <div class="chart-header">
              <h3>ğŸ“Š æµé‡æ¸ é“</h3>
              <div class="toggle-group">
                <button class="toggle-btn ${toggleState.channel === 'pv' ? 'active' : ''}" onclick="setToggle('channel','pv',this)">PV</button>
                <button class="toggle-btn ${toggleState.channel === 'uv' ? 'active' : ''}" onclick="setToggle('channel','uv',this)">UV</button>
              </div>
            </div>
            <div class="channel-bar"><span class="channel-label">ç›´æ¥è®¿é—®</span><div class="channel-track"><div class="channel-fill direct" style="width:${Math.max(5, (channels.direct || 0) / totalChannels * 100)}%">${channels.direct || 0}</div></div></div>
            <div class="channel-bar"><span class="channel-label">æœç´¢å¼•æ“</span><div class="channel-track"><div class="channel-fill search" style="width:${Math.max(5, (channels.search || 0) / totalChannels * 100)}%">${channels.search || 0}</div></div></div>
            <div class="channel-bar"><span class="channel-label">ç¤¾äº¤åª’ä½“</span><div class="channel-track"><div class="channel-fill social" style="width:${Math.max(5, (channels.social || 0) / totalChannels * 100)}%">${channels.social || 0}</div></div></div>
            <div class="channel-bar"><span class="channel-label">å¤–éƒ¨é“¾æ¥</span><div class="channel-track"><div class="channel-fill referral" style="width:${Math.max(5, (channels.referral || 0) / totalChannels * 100)}%">${channels.referral || 0}</div></div></div>
          </div>
          <div class="card">
            <div class="chart-header"><h3>â±ï¸ å®æ—¶æµé‡</h3><span class="badge">æœ€è¿‘1å°æ—¶</span></div>
            <div class="chart-container"><canvas id="trendChart"></canvas></div>
          </div>
        </div>

        <div class="card" style="margin-bottom:1.5rem">
          <div class="chart-header">
            <h3>ğŸŒŠ ç”¨æˆ·è¡Œä¸ºæµå‘</h3>
            <div class="layer-controls">
              <span style="font-size:0.65rem;color:var(--text-3);margin-right:0.5rem">å±‚æ•°:</span>
              ${[1, 2, 3, 4, 5, 6, 7, 8].map(n => `<button class="layer-btn ${n === currentLayers ? 'active' : ''}" data-layers="${n}" onclick="reloadSankey(${n})">${n}</button>`).join('')}
            </div>
          </div>
          <div id="sankeyChart"></div>
        </div>

        <div class="grid-2">
          <div class="card">
            <div class="chart-header"><h3>ğŸ‘¥ æœ€è¿‘è®¿å®¢</h3><span class="badge">${visitorsData.visitors.length}æ¡</span></div>
            <div class="visitors-table"><table>
              <thead><tr><th>æ—¶é—´</th><th>IP</th><th>é¡µé¢</th><th>è®¾å¤‡</th></tr></thead>
              <tbody>${visitorsData.visitors.length ? visitorsData.visitors.slice(0, 8).map(v => `
                <tr><td><span class="time-badge">${formatTime(v.timestamp)}</span></td><td><span class="ip-badge">${v.ip || '-'}</span></td><td><span class="url-badge" title="${v.url}">${v.url || '/'}</span></td><td><span class="device-badge">${getDeviceIcon(v.device?.type)} ${v.device?.browser || '-'}</span></td></tr>
              `).join('') : '<tr><td colspan="4"><div class="empty-state">æš‚æ— æ•°æ®</div></td></tr>'}</tbody>
            </table></div>
          </div>
          <div class="card">
            <div class="chart-header"><h3>ğŸšª å…¥å£/å‡ºå£é¡µé¢</h3></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
              <div><div style="font-size:0.7rem;color:var(--accent-2);margin-bottom:0.5rem">ğŸ”¹ å…¥å£é¡µ</div>
                ${(data.entryPages || []).slice(0, 4).map((p, i) => `<div style="display:flex;justify-content:space-between;padding:0.25rem 0;font-size:0.7rem;border-bottom:1px solid var(--border)"><span class="url-badge">${p.url}</span><span>${p.count}</span></div>`).join('') || '<div class="empty-state">æš‚æ— </div>'}
              </div>
              <div><div style="font-size:0.7rem;color:var(--accent-1);margin-bottom:0.5rem">ğŸ”¸ å‡ºå£é¡µ</div>
                ${(data.exitPages || []).slice(0, 4).map((p, i) => `<div style="display:flex;justify-content:space-between;padding:0.25rem 0;font-size:0.7rem;border-bottom:1px solid var(--border)"><span class="url-badge">${p.url}</span><span>${p.count}</span></div>`).join('') || '<div class="empty-state">æš‚æ— </div>'}
              </div>
            </div>
          </div>
        </div>

        <div class="grid-2" style="margin-top:1.5rem">
          <div class="card">
            <div class="chart-header">
              <h3>ğŸ”¥ çƒ­é—¨é¡µé¢</h3>
              <div class="toggle-group">
                <button class="toggle-btn ${toggleState.pages === 'pv' ? 'active' : ''}" onclick="setToggle('pages','pv',this)">PV</button>
                <button class="toggle-btn ${toggleState.pages === 'uv' ? 'active' : ''}" onclick="setToggle('pages','uv',this)">UV</button>
              </div>
            </div>
            <table><thead><tr><th>#</th><th>é¡µé¢</th><th style="text-align:right">${toggleState.pages === 'pv' ? 'æµè§ˆé‡' : 'è®¿å®¢æ•°'}</th></tr></thead>
            <tbody>${topPages.length ? topPages.slice(0, 6).map((p, i) => `
              <tr><td><span class="rank ${i < 3 ? 'rank-' + (i + 1) : 'rank-n'}">${i + 1}</span></td><td><span class="url-badge" title="${p.url}">${p.url}</span></td><td style="text-align:right"><span class="count-pill">${p.count}</span></td></tr>
            `).join('') : '<tr><td colspan="3"><div class="empty-state">æš‚æ— </div></td></tr>'}</tbody></table>
          </div>
          <div class="card">
            <div class="chart-header"><h3>ğŸ”— æµé‡æ¥æº</h3></div>
            <table><thead><tr><th>#</th><th>æ¥æº</th><th style="text-align:right">æ¬¡æ•°</th></tr></thead>
            <tbody>${data.topReferrers?.length ? data.topReferrers.slice(0, 6).map((r, i) => `
              <tr><td><span class="rank ${i < 3 ? 'rank-' + (i + 1) : 'rank-n'}">${i + 1}</span></td><td><span class="url-badge">${formatRef(r.referrer)}</span></td><td style="text-align:right"><span class="count-pill">${r.count}</span></td></tr>
            `).join('') : '<tr><td colspan="3"><div class="empty-state">æš‚æ— </div></td></tr>'}</tbody></table>
          </div>
        </div>
      `;
      renderTrendChart(data.minuteTrend);
      renderHourlyChart(data.hourlyTrend);
      renderDeviceChart(data.deviceStats?.[toggleState.device]);
      renderBrowserChart(data.browserStats?.[toggleState.browser]);
      renderSankey(flow);
    }

    function renderTrendChart(trend) {
      const ctx = document.getElementById('trendChart')?.getContext('2d');
      if (!ctx) return;
      if (trendChart) trendChart.destroy();
      const gradient = ctx.createLinearGradient(0, 0, 0, 200);
      gradient.addColorStop(0, 'rgba(255,107,107,0.25)');
      gradient.addColorStop(1, 'rgba(255,107,107,0)');
      trendChart = new Chart(ctx, {
        type: 'line',
        data: { labels: (trend || []).map(d => d.minute?.split(' ')[1] || ''), datasets: [{ data: (trend || []).map(d => d.count), borderColor: '#ff6b6b', backgroundColor: gradient, fill: true, tension: 0.4, pointRadius: 0, borderWidth: 2 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false, beginAtZero: true } } }
      });
    }

    function renderHourlyChart(hourly) {
      const ctx = document.getElementById('hourlyChart')?.getContext('2d');
      if (!ctx) return;
      if (hourlyChart) hourlyChart.destroy();
      hourlyChart = new Chart(ctx, {
        type: 'bar',
        data: { labels: (hourly || []).map(d => currentRange === 'today' ? `${d.hour}:00` : d.hour), datasets: [{ data: (hourly || []).map(d => d.count), backgroundColor: ctx => { const { ctx: c, chartArea } = ctx.chart; if (!chartArea) return '#4ecdc4'; const g = c.createLinearGradient(0, chartArea.bottom, 0, chartArea.top); g.addColorStop(0, '#4ecdc4'); g.addColorStop(1, '#ff6b6b'); return g; }, borderRadius: 4, borderSkipped: false }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { color: 'rgba(255,255,255,0.3)', font: { size: 9 } } }, y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { color: 'rgba(255,255,255,0.3)', font: { size: 9 } } } } }
      });
    }

    function renderDeviceChart(stats) {
      const ctx = document.getElementById('deviceChart')?.getContext('2d');
      if (!ctx) return;
      if (deviceChart) deviceChart.destroy();
      deviceChart = new Chart(ctx, {
        type: 'doughnut',
        data: { labels: ['æ¡Œé¢ç«¯', 'ç§»åŠ¨ç«¯', 'å¹³æ¿'], datasets: [{ data: [stats?.desktop || 0, stats?.mobile || 0, stats?.tablet || 0], backgroundColor: ['#ff6b6b', '#4ecdc4', '#ffe66d'], borderWidth: 0 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: 'rgba(255,255,255,0.6)', font: { size: 9 }, boxWidth: 10, padding: 6 } } }, cutout: '65%' }
      });
    }

    function renderBrowserChart(stats) {
      const ctx = document.getElementById('browserChart')?.getContext('2d');
      if (!ctx) return;
      if (browserChart) browserChart.destroy();
      const labels = Object.keys(stats || {});
      const values = Object.values(stats || {});
      const colors = ['#ff6b6b', '#4ecdc4', '#ffe66d', '#95e1d3', '#a29bfe', '#fd79a8'];
      browserChart = new Chart(ctx, {
        type: 'doughnut',
        data: { labels, datasets: [{ data: values, backgroundColor: colors.slice(0, labels.length), borderWidth: 0 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: 'rgba(255,255,255,0.6)', font: { size: 9 }, boxWidth: 10, padding: 6 } } }, cutout: '65%' }
      });
    }

    function renderSankey(flow) {
      const container = document.getElementById('sankeyChart');
      if (!container) return;
      if (!flow?.nodes?.length) { container.innerHTML = '<div class="empty-state">æš‚æ— æµå‘æ•°æ®</div>'; return; }
      if (sankeyChart) sankeyChart.dispose();
      sankeyChart = echarts.init(container);
      const colors = ['#ff6b6b', '#4ecdc4', '#ffe66d', '#95e1d3', '#a29bfe', '#fd79a8', '#00b894'];
      sankeyChart.setOption({
        tooltip: { trigger: 'item', backgroundColor: 'rgba(10,10,15,0.95)', borderColor: 'rgba(255,255,255,0.1)', textStyle: { color: '#fff', fontSize: 11 } },
        series: [{ type: 'sankey', layout: 'none', emphasis: { focus: 'adjacency' }, nodeAlign: 'left', lineStyle: { color: 'gradient', curveness: 0.5, opacity: 0.3 }, itemStyle: { borderWidth: 0 }, label: { color: '#fff', fontSize: 9 }, data: flow.nodes.map((n, i) => ({ ...n, itemStyle: { color: colors[i % colors.length] } })), links: flow.links }]
      });
      window.addEventListener('resize', () => sankeyChart?.resize());
    }

    function formatNum(n) { if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M'; if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K'; return n?.toLocaleString() || '0'; }
    function formatTime(ts) { if (!ts) return '-'; const d = new Date(ts); return `${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`; }
    function formatRef(ref) { if (!ref || ref === 'direct') return 'ç›´æ¥è®¿é—®'; try { return new URL(ref).hostname; } catch { return ref.slice(0, 25); } }
    function getDeviceIcon(type) { return type === 'mobile' ? 'ğŸ“±' : type === 'tablet' ? 'ğŸ“±' : 'ğŸ’»'; }

    function showClearModal() {
      document.getElementById('modal-container').innerHTML = `
        <div class="modal-overlay" onclick="closeModal()">
          <div class="modal" onclick="event.stopPropagation()">
            <h3>âš ï¸ ç¡®è®¤æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿ</h3>
            <p>æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼</p>
            <div class="modal-buttons">
              <button class="btn btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
              <button class="btn btn-confirm-delete" onclick="confirmClear()">ç¡®è®¤åˆ é™¤</button>
            </div>
          </div>
        </div>
      `;
    }
    function closeModal() { document.getElementById('modal-container').innerHTML = ''; }
    async function confirmClear() {
      const res = await fetch('/api/clear?confirm=yes-delete-all-data', { method: 'DELETE' });
      if (res.ok) { closeModal(); loadStats(); } else { alert('æ¸…ç©ºå¤±è´¥'); }
    }

    loadStats();
    setInterval(loadStats, 30000);
  </script>
</body>

</html>