<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æµé‡åˆ†æ Â· Analytics</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <style>
    :root {
      --bg-dark: #0a0a0f;
      --bg-card: rgba(20, 20, 30, 0.6);
      --border: rgba(255, 255, 255, 0.06);
      --accent-1: #ff6b6b;
      --accent-2: #4ecdc4;
      --accent-3: #ffe66d;
      --accent-4: #95e1d3;
      --text-1: #ffffff;
      --text-2: rgba(255, 255, 255, 0.6);
      --text-3: rgba(255, 255, 255, 0.3);
      --danger: #e74c3c;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Space Grotesk', sans-serif;
      background: var(--bg-dark);
      color: var(--text-1);
      min-height: 100vh;
    }

    .bg-mesh {
      position: fixed;
      inset: 0;
      z-index: 0;
      background: radial-gradient(ellipse 80% 50% at 20% 40%, rgba(255, 107, 107, 0.15) 0%, transparent 50%), radial-gradient(ellipse 60% 40% at 80% 20%, rgba(78, 205, 196, 0.12) 0%, transparent 50%);
      animation: meshFloat 30s ease-in-out infinite;
    }

    @keyframes meshFloat {

      0%,
      100% {
        filter: blur(60px);
      }

      50% {
        filter: blur(80px) brightness(1.2);
      }
    }

    .container {
      position: relative;
      z-index: 2;
      max-width: 1500px;
      margin: 0 auto;
      padding: 2rem;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
      gap: 1rem;
    }

    .brand h1 {
      font-size: 2rem;
      background: linear-gradient(135deg, var(--text-1), var(--text-2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .brand p {
      font-size: 0.75rem;
      color: var(--text-3);
      text-transform: uppercase;
      letter-spacing: 0.2em;
    }

    .header-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .live-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 100px;
      font-size: 0.8rem;
    }

    .pulse {
      width: 8px;
      height: 8px;
      background: var(--accent-2);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        box-shadow: 0 0 0 0 rgba(78, 205, 196, 0.5);
      }

      50% {
        box-shadow: 0 0 0 10px transparent;
      }
    }

    .btn {
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn-danger {
      background: rgba(231, 76, 60, 0.2);
      color: var(--danger);
      border: 1px solid var(--danger);
    }

    .btn-danger:hover {
      background: var(--danger);
      color: white;
    }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 1.5rem;
      backdrop-filter: blur(40px);
    }

    .bento {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .stat-card .label {
      font-size: 0.7rem;
      color: var(--text-3);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .stat-card .value {
      font-size: 2.5rem;
      font-weight: 700;
    }

    .stat-card:nth-child(1) .value {
      color: var(--accent-1);
    }

    .stat-card:nth-child(2) .value {
      color: var(--accent-2);
    }

    .stat-card:nth-child(3) .value {
      color: var(--accent-3);
    }

    .stat-card:nth-child(4) .value {
      color: var(--accent-4);
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .chart-container {
      height: 220px;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .chart-header h3 {
      font-size: 1rem;
      font-weight: 500;
      color: var(--text-2);
    }

    .badge {
      font-size: 0.65rem;
      padding: 0.25rem 0.6rem;
      background: rgba(255, 107, 107, 0.15);
      color: var(--accent-1);
      border-radius: 100px;
    }

    #sankeyChart {
      height: 350px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    th {
      text-align: left;
      padding: 0.75rem 0;
      font-size: 0.65rem;
      color: var(--text-3);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      border-bottom: 1px solid var(--border);
    }

    td {
      padding: 0.75rem 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.03);
    }

    tr:hover {
      background: rgba(255, 255, 255, 0.02);
    }

    .visitors-table {
      max-height: 400px;
      overflow-y: auto;
    }

    .ip-badge {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      background: rgba(78, 205, 196, 0.15);
      color: var(--accent-2);
      border-radius: 6px;
      font-family: monospace;
      font-size: 0.75rem;
    }

    .device-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.2rem 0.5rem;
      background: rgba(255, 230, 109, 0.15);
      color: var(--accent-3);
      border-radius: 6px;
      font-size: 0.7rem;
    }

    .url-badge {
      display: inline-block;
      max-width: 150px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      padding: 0.2rem 0.5rem;
      background: rgba(255, 107, 107, 0.1);
      border-radius: 6px;
      font-size: 0.75rem;
    }

    .time-badge {
      font-size: 0.7rem;
      color: var(--text-3);
    }

    .rank {
      width: 22px;
      height: 22px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
    }

    .rank-1 {
      background: linear-gradient(135deg, #ffd700, #ffb347);
      color: #000;
    }

    .rank-2 {
      background: linear-gradient(135deg, #c0c0c0, #a8a8a8);
      color: #000;
    }

    .rank-3 {
      background: linear-gradient(135deg, #cd7f32, #b8860b);
      color: #000;
    }

    .rank-n {
      background: var(--bg-card);
      color: var(--text-3);
      border: 1px solid var(--border);
    }

    .count-pill {
      padding: 0.3rem 0.6rem;
      background: linear-gradient(135deg, rgba(255, 107, 107, 0.1), rgba(78, 205, 196, 0.1));
      border: 1px solid var(--border);
      border-radius: 6px;
      font-weight: 600;
      font-size: 0.8rem;
    }

    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 50vh;
      gap: 1rem;
    }

    .loader {
      width: 40px;
      height: 40px;
      border: 2px solid var(--border);
      border-top-color: var(--accent-1);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .empty-state {
      text-align: center;
      padding: 2rem;
      color: var(--text-3);
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal {
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 2rem;
      max-width: 400px;
      text-align: center;
    }

    .modal h3 {
      margin-bottom: 1rem;
      color: var(--danger);
    }

    .modal p {
      color: var(--text-2);
      margin-bottom: 1.5rem;
      font-size: 0.9rem;
    }

    .modal-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    .btn-cancel {
      background: var(--bg-card);
      color: var(--text-2);
      border: 1px solid var(--border);
    }

    .btn-confirm-delete {
      background: var(--danger);
      color: white;
    }

    @media (max-width: 1200px) {

      .bento,
      .grid-2 {
        grid-template-columns: repeat(2, 1fr);
      }

      .grid-3 {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .bento {
        grid-template-columns: 1fr;
      }

      header {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>

<body>
  <div class="bg-mesh"></div>
  <div class="container">
    <header>
      <div class="brand">
        <h1>Analytics</h1>
        <p>Real-time Insights</p>
      </div>
      <div class="header-actions">
        <div class="live-indicator"><span class="pulse"></span><span id="lastUpdated">åŠ è½½ä¸­...</span></div>
        <button class="btn btn-danger" onclick="showClearModal()">ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®</button>
      </div>
    </header>
    <div id="content">
      <div class="loading">
        <div class="loader"></div>
        <p style="color:var(--text-3)">åŠ è½½æ•°æ®ä¸­...</p>
      </div>
    </div>
    <div id="modal-container"></div>
  </div>

  <script>
    let trendChart = null, hourlyChart = null, sankeyChart = null;

    async function loadStats() {
      try {
        const [statsRes, flowRes, visitorsRes] = await Promise.all([
          fetch('/api/stats'),
          fetch('/api/flow'),
          fetch('/api/visitors?limit=30')
        ]);
        if (!statsRes.ok) throw new Error('åŠ è½½å¤±è´¥');
        const stats = await statsRes.json();
        const flow = flowRes.ok ? await flowRes.json() : { nodes: [], links: [] };
        const visitors = visitorsRes.ok ? await visitorsRes.json() : { visitors: [] };
        renderDashboard(stats, flow, visitors);
        document.getElementById('lastUpdated').textContent = `æ›´æ–°äº ${new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}`;
      } catch (error) {
        document.getElementById('content').innerHTML = `<div class="empty-state"><p>âš ï¸ ${error.message}</p></div>`;
      }
    }

    function renderDashboard(data, flow, visitorsData) {
      const avgDepth = data.uv > 0 ? (data.pv / data.uv).toFixed(1) : '0';
      const bounceRate = data.uv > 0 ? Math.max(15, 100 - (data.pv / data.uv * 12)).toFixed(1) : '0';

      document.getElementById('content').innerHTML = `
        <div class="bento">
          <div class="card stat-card"><div class="label">é¡µé¢æµè§ˆé‡</div><div class="value">${formatNum(data.pv)}</div></div>
          <div class="card stat-card"><div class="label">ç‹¬ç«‹è®¿å®¢</div><div class="value">${formatNum(data.uv)}</div></div>
          <div class="card stat-card"><div class="label">è®¿é—®æ·±åº¦</div><div class="value">${avgDepth}</div></div>
          <div class="card stat-card"><div class="label">è·³å‡ºç‡</div><div class="value">${bounceRate}%</div></div>
        </div>

        <div class="grid-2">
          <div class="card"><div class="chart-header"><h3>ğŸ“ˆ å®æ—¶æµé‡</h3><span class="badge">æœ€è¿‘1å°æ—¶</span></div><div class="chart-container"><canvas id="trendChart"></canvas></div></div>
          <div class="card"><div class="chart-header"><h3>ğŸ• ä»Šæ—¥åˆ†æ—¶</h3></div><div class="chart-container"><canvas id="hourlyChart"></canvas></div></div>
        </div>

        <div class="card" style="margin-bottom:2rem">
          <div class="chart-header"><h3>ğŸŒŠ ç”¨æˆ·è¡Œä¸ºæµå‘</h3><span class="badge">æ¡‘åŸºå›¾</span></div>
          <div id="sankeyChart"></div>
        </div>

        <div class="card" style="margin-bottom:2rem">
          <div class="chart-header"><h3>ğŸ‘¥ æœ€è¿‘è®¿å®¢</h3><span class="badge">${visitorsData.visitors.length} æ¡è®°å½•</span></div>
          <div class="visitors-table">
            <table>
              <thead><tr><th>æ—¶é—´</th><th>IP</th><th>é¡µé¢</th><th>è®¾å¤‡</th><th>æ¥æº</th></tr></thead>
              <tbody>
                ${visitorsData.visitors.length ? visitorsData.visitors.map(v => `
                  <tr>
                    <td><span class="time-badge">${formatTime(v.timestamp)}</span></td>
                    <td><span class="ip-badge">${v.ip || '-'}</span></td>
                    <td><span class="url-badge" title="${v.url}">${v.url || '/'}</span></td>
                    <td><span class="device-badge">${getDeviceIcon(v.device?.type)} ${v.device?.browser || '-'}</span></td>
                    <td><span class="url-badge" title="${v.referrer}">${v.referrer ? formatRef(v.referrer) : 'ç›´æ¥'}</span></td>
                  </tr>
                `).join('') : '<tr><td colspan="5"><div class="empty-state">æš‚æ— è®¿å®¢æ•°æ®</div></td></tr>'}
              </tbody>
            </table>
          </div>
        </div>

        <div class="grid-2">
          <div class="card">
            <div class="chart-header"><h3>ğŸ”¥ çƒ­é—¨é¡µé¢</h3></div>
            <table>
              <thead><tr><th>#</th><th>é¡µé¢</th><th style="text-align:right">æµè§ˆé‡</th></tr></thead>
              <tbody>${data.topPages.length ? data.topPages.slice(0, 8).map((p, i) => `
                <tr><td><span class="rank ${i < 3 ? 'rank-' + (i + 1) : 'rank-n'}">${i + 1}</span></td><td><span class="url-badge" title="${p.url}">${p.url}</span></td><td style="text-align:right"><span class="count-pill">${p.count}</span></td></tr>
              `).join('') : '<tr><td colspan="3"><div class="empty-state">æš‚æ— æ•°æ®</div></td></tr>'}</tbody>
            </table>
          </div>
          <div class="card">
            <div class="chart-header"><h3>ğŸ”— æµé‡æ¥æº</h3></div>
            <table>
              <thead><tr><th>#</th><th>æ¥æº</th><th style="text-align:right">è®¿é—®é‡</th></tr></thead>
              <tbody>${data.topReferrers.length ? data.topReferrers.slice(0, 8).map((r, i) => `
                <tr><td><span class="rank ${i < 3 ? 'rank-' + (i + 1) : 'rank-n'}">${i + 1}</span></td><td><span class="url-badge">${formatRef(r.referrer)}</span></td><td style="text-align:right"><span class="count-pill">${r.count}</span></td></tr>
              `).join('') : '<tr><td colspan="3"><div class="empty-state">æš‚æ— æ•°æ®</div></td></tr>'}</tbody>
            </table>
          </div>
        </div>
      `;
      renderTrendChart(data.minuteTrend);
      renderHourlyChart(data.hourlyTrend);
      renderSankey(flow);
    }

    function renderTrendChart(trend) {
      const ctx = document.getElementById('trendChart')?.getContext('2d');
      if (!ctx) return;
      if (trendChart) trendChart.destroy();
      const gradient = ctx.createLinearGradient(0, 0, 0, 220);
      gradient.addColorStop(0, 'rgba(255,107,107,0.3)');
      gradient.addColorStop(1, 'rgba(255,107,107,0)');
      trendChart = new Chart(ctx, {
        type: 'line',
        data: { labels: trend.map(d => d.minute?.split(' ')[1] || ''), datasets: [{ data: trend.map(d => d.count), borderColor: '#ff6b6b', backgroundColor: gradient, fill: true, tension: 0.4, pointRadius: 0, borderWidth: 2 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { color: 'rgba(255,255,255,0.3)', maxTicksLimit: 6, font: { size: 10 } } }, y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { color: 'rgba(255,255,255,0.3)', font: { size: 10 } } } } }
      });
    }

    function renderHourlyChart(hourly) {
      const ctx = document.getElementById('hourlyChart')?.getContext('2d');
      if (!ctx) return;
      if (hourlyChart) hourlyChart.destroy();
      hourlyChart = new Chart(ctx, {
        type: 'bar',
        data: { labels: hourly.map(d => `${d.hour}:00`), datasets: [{ data: hourly.map(d => d.count), backgroundColor: ctx => { const { ctx: c, chartArea } = ctx.chart; if (!chartArea) return '#4ecdc4'; const g = c.createLinearGradient(0, chartArea.bottom, 0, chartArea.top); g.addColorStop(0, '#4ecdc4'); g.addColorStop(1, '#ff6b6b'); return g; }, borderRadius: 6, borderSkipped: false }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { color: 'rgba(255,255,255,0.3)', font: { size: 10 } } }, y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { color: 'rgba(255,255,255,0.3)', font: { size: 10 } } } } }
      });
    }

    function renderSankey(flow) {
      const container = document.getElementById('sankeyChart');
      if (!container) return;
      if (!flow.nodes.length) { container.innerHTML = '<div class="empty-state">æš‚æ— æµå‘æ•°æ®</div>'; return; }
      if (sankeyChart) sankeyChart.dispose();
      sankeyChart = echarts.init(container);
      const colors = ['#ff6b6b', '#4ecdc4', '#ffe66d', '#95e1d3', '#a29bfe', '#fd79a8', '#00b894'];
      sankeyChart.setOption({
        tooltip: { trigger: 'item', backgroundColor: 'rgba(10,10,15,0.95)', borderColor: 'rgba(255,255,255,0.1)', textStyle: { color: '#fff' }, formatter: p => p.dataType === 'edge' ? `<b>${p.data.source}</b> â†’ <b>${p.data.target}</b><br/>è®¿é—®: ${p.data.value}` : `<b>${p.name}</b>` },
        series: [{ type: 'sankey', layout: 'none', emphasis: { focus: 'adjacency' }, nodeAlign: 'left', lineStyle: { color: 'gradient', curveness: 0.5, opacity: 0.35 }, itemStyle: { borderWidth: 0 }, label: { color: '#fff', fontSize: 10 }, data: flow.nodes.map((n, i) => ({ ...n, itemStyle: { color: colors[i % colors.length] } })), links: flow.links }]
      });
      window.addEventListener('resize', () => sankeyChart?.resize());
    }

    function formatNum(n) { if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M'; if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K'; return n.toLocaleString(); }
    function formatTime(ts) { if (!ts) return '-'; const d = new Date(ts); return `${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`; }
    function formatRef(ref) { if (!ref || ref === 'direct') return 'ç›´æ¥è®¿é—®'; try { return new URL(ref).hostname; } catch { return ref.slice(0, 30); } }
    function getDeviceIcon(type) { if (type === 'mobile') return 'ğŸ“±'; if (type === 'tablet') return 'ğŸ“±'; return 'ğŸ’»'; }

    function showClearModal() {
      document.getElementById('modal-container').innerHTML = `
        <div class="modal-overlay" onclick="closeModal()">
          <div class="modal" onclick="event.stopPropagation()">
            <h3>âš ï¸ ç¡®è®¤æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿ</h3>
            <p>æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼æ‰€æœ‰è®¿å®¢è®°å½•ã€é¡µé¢æµè§ˆæ•°æ®éƒ½å°†è¢«æ°¸ä¹…åˆ é™¤ã€‚</p>
            <div class="modal-buttons">
              <button class="btn btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
              <button class="btn btn-confirm-delete" onclick="confirmClear()">ç¡®è®¤åˆ é™¤</button>
            </div>
          </div>
        </div>
      `;
    }

    function closeModal() { document.getElementById('modal-container').innerHTML = ''; }

    async function confirmClear() {
      try {
        const res = await fetch('/api/clear?confirm=yes-delete-all-data', { method: 'DELETE' });
        if (res.ok) { closeModal(); loadStats(); alert('âœ… æ•°æ®å·²æ¸…ç©º'); }
        else { alert('âŒ æ¸…ç©ºå¤±è´¥'); }
      } catch (e) { alert('âŒ è¯·æ±‚å¤±è´¥: ' + e.message); }
    }

    loadStats();
    setInterval(loadStats, 30000);
  </script>
</body>

</html>